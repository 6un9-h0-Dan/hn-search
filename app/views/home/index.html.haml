#search-panel
  %h1.text-center
    HN Search

  .search_box-wrapper
    .search_box
      %form#search-form{method: "get", action: '#', onsubmit: 'return false;'}
        #inputfield
          %input.autocomplete{autocomplete: 'off', name: 'address', placeholder: 'HN News title, Source, Author name ...', type: 'text', spellcheck: 'false'}
        .searchbutton
          %i.icon-search.icon-large
        #hits
  .text-center
    %small <strong>#{number_with_delimiter Post.count}</strong> news crawled
  %footer
    .text-center
      %small Made with <i class="icon-heart text-danger"></i> in Paris,
      %small powered by
      = link_to image_tag("http://d3ibatyzauff7b.cloudfront.net/assets/algolia128x40.png", style: 'height: 1em;'), "http://www.algolia.com", onclick: "_gaq.push(['_link', 'http://www.algolia.com']); return false;"


  :javascript
    var apiClient = new AlgoliaSearch('#{ENV['ALGOLIASEARCH_APPLICATION_ID']}', '#{ENV['ALGOLIASEARCH_API_KEY_RO']}', 'https:' == document.location.protocol ? 'https' : 'http');
    var idx = apiClient.initIndex('#{Post.index_name}');
    var $hits = $('#hits');
    var page = 0;

    function searchCallback(success, content) {
      if (page != 0 && page >= content.page) {
        return;
      }
      page = content.page;
      var res = '';
      for (var i = 0; i < content.hits.length; ++i) {
        var hit = content.hits[i];
        var clazz = 'hit';
        if ((i % 2) == 1) {
          clazz += ' bg';
        }
        res +=  '<div class="' + clazz + '">' +
        '  <div class="author text-right">' + hit._highlightResult.author.value + '</div>' +
        '  <img class="thumb pull-left" src="//api.snapito.com/web/f33c486abee039b021dd86b4338310f3b61342d6/tc?fast=yes&freshness=86400&url=' + hit.url + '" />' +
        '  <div class="title_url">' +
        '    <div class="title">' + hit._highlightResult.title.value + '</div>' +
        '    <div class="url"><a href="' + hit.url + '" target="_blank">' + hit._highlightResult.url.value + '</a></div>' +
        '  </div>' +
        '  <div class="clearfix"></div>' +
        '  <div class="source pull-right">' + hit._highlightResult.source.value + '</div>' +
        '  <div class="created_at pull-right"><abbr class="timeago" title=' + hit.created_at + '></abbr></div>' +
        '  <div class="points pull-left"><b>' + hit.points + '</b> point' + (hit.points > 1 ? 's' : '') + '</div>' +
        '  <div class="comments pull-left"><a href="https://news.ycombinator.com/item?id=' + hit.hn_id + '" target="_blank">' + hit.comments + ' comment' + (hit.comments > 1 ? 's' : '') + '</a></div>' +
        '  <div class="clearfix"></div>' +
        '</div>';
      }
      $hits.append(res);
      $('#hits .timeago').timeago();
    }

    function search(p) {
      if ((page > 0 && p <= page) || page > 50) {
        return;
      }
      var query = $('#inputfield input').val().trim();
      if (query.length == 0) {
        $hits.empty();
        return;
      }
      if (p == 0) {
        $hits.empty();
      }
      idx.search(query, searchCallback, { "hitsPerPage" : 25, "page" : p });
    }

    $(document).ready(function() {
      $(window).scroll(function () {
        if ($(window).scrollTop() >= $(document).height() - $(window).height() - 10) {
          search(page + 1);
        }
      });

      $('#inputfield input').keyup(function() {
        page = 0;
        search(0);
      }).focus();

      // resolve DNS
      idx.search("", function(success, content) { });
    });
